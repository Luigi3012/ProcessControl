<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name='viewport' content='initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no'>
    <script src="../JSBridge.js"></script>
    <link rel="stylesheet" type="text/css" href="processControl.css">
</head>
<body onload="init()">
	<script>
        var activeState = "active";
        var completedState = "completed";
        var futureState = "future";
        
        var stepArray = [ {id: "1", text: "Contact lead", desc: "First description of this step.", state: 2}, {id: "2", text: "Show what we have", desc: "This will be cool feature.", state: 1},
            {id: "3", text: "Create offer", desc: "", state: 0},{id: "4", text: "Sign the deal", desc: "Aaaaand finally, get ready to try it.", state: 0}]
        
        function init(){
            var urlParams = new URLSearchParams(window.location.search);
            var processControlName = urlParams.get('name');
            MobileCRM.bridge.command("getProcessControlConfiguration", processControlName, setUpProcessArrows, failed, null);            
        }

        function setUpProcessArrows(jsonConfig){
            MobileCRM.bridge.alert(jsonConfig);
            var stepContainer = document.getElementById("stepContainer");
            for(var field of stepArray){
                stepContainer.appendChild(htmlToElements(createArrow2(field.text, field.id, field.desc)))
            }
        }

        function setStepOnEntity(){
            MobileCRM.UI.EntityForm.requestObject(
                function (entityForm) {
                    /// <param name="entityForm" type="MobileCRM.UI.EntityForm"/>
                    var entityFields = entityForm.entity.properties;                
                },
                function (err) {
                    MobileCRM.bridge.alert("An error occurred: " + err);
                },
                null
            );       
        }

        function createArrow2(name, value, description){
            var arrowHtml = "<li id="+ value +" class=\"future\" onclick=\"arrowClicked(this.id)\">" +
            "<span>" +
            "<strong>" + name + "</strong>" +
            description +
            "</span><i></i>" +
            "</li>";
            return arrowHtml;
        }

        /**
        * @param {String} HTML representing any number of sibling elements
        * @return {NodeList} 
        */
        function htmlToElements(html) {
            var template = document.createElement('template');
            html = html.trim();
            template.innerHTML = html;
            return template.content.firstChild;
        }

        function loadData(){
            // Request WF configuration from JS
            return dataObj;
        }

        function arrowClicked(elementId){
            console.log(event);
            var element = document.getElementById(elementId);
            var stateFromClass = element.className;
            var step = stepArray.find(s => s.id === elementId);
            if(step){
                switch(stateFromClass) {
                case activeState:
                    setArrowCssClass(element, completedState);
                    setPreviousElementsToState(stepArray.indexOf(step), completed);
                    setNextElementsToState(stepArray.indexOf(step), futureState);
                    break;
                case completedState:
                    setArrowCssClass(element, futureState);  // Reset state
                    setPreviousElementsToState(stepArray.indexOf(step), completedState);
                    break;
                case futureState:                  
                    setArrowCssClass(element, activeState);
                    setPreviousElementsToState(stepArray.indexOf(step), completedState);
                    setNextElementsToState(stepArray.indexOf(step), futureState);
                    break;
                } 
            }
        }

        function setPreviousElementsToState(index, state){
            for(var i = 0; i < index; i++){
                var element = document.getElementById(stepArray[i].id);
                setArrowCssClass(element, state);
            }
        }

        function setNextElementsToState(index, state){
            for(var i = index + 1; i < stepArray.length; i++){
                var element = document.getElementById(stepArray[i].id);
                setArrowCssClass(element, state);
            }
        }

        function setArrowCssClass(element, state){
            element.className = state;            
        }

        function setArrowCssClass2(elementId, state){
            var element = document.getElementById(elementId);
            element.className = state;            
        }

    </script>
    <div id="processContainer" class="processContainer">
    </div>
    <ul id="stepContainer" class="steps"></ul>
</body>